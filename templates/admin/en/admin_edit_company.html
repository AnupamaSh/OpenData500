{% extends "../../main.html" %}
{% autoescape None %}

{% block body %}
<style>

</style>

<br>
<br>
<br>
<br>
<br>
<h2>{{ page_heading }}</h2>
<form method="post" id="company_form_admin" class="m-form company_form_admin" data-parsley-validate>

	{% module Form(country, settings['default_language'], False, True, company) %}

	<h2 class="data-section">Data Use and Source Information </h2>

	<!--*****************************************************************-EXAMPLE USES-***************************************************************** !-->
	<fieldset class="m-form-half right">
		<h3>Provide any specific examples of how your company uses open data.<br> <em>[200 words or less]</em></h3>
		<textarea rows="10" cols="59" name="exampleUses" id="exampleUses" 
		data-parsley-trigger="keyup" 
		data-parsley-maxwords="200" 
		data-parsley-error-message="You are over the word limit.">{%if company.exampleUses %}{{ company.exampleUses }}{%else%}{%end%}</textarea><br>

	<!--*****************************************************************-DATA SOURCES-***************************************************************** !-->
		<h3>From approximately how many sources (i.e. agencies, subagencies, local and state governments) does your company use data? *</h3>
		<div class="source-count-buttons">
			{% for count in source_count %}
				<input type="radio" name="sourceCount" id="{{count}}" value="{{count}}" {% if company.sourceCount == count %}checked{%end%}><label for="{{count}}">{{count}}</label><br>
			{%end %}
			<input type="radio" name="sourceCount" id="NA" value="NA" {% if company.sourceCount == 'NA' %}checked{%end%}><label for="NA">NA</label><br>
		</div>
	</fieldset>

	<!--*****************************************************************-DATA TYPES-***************************************************************** !-->
	<fieldset class="m-form-half">
		<h3>What types of data does your company use? <br><em>(check all that apply)</em></h3>
		<div class="data-type-field">
			{% for data_type in data_types %}
				<input type="checkbox" id="{{data_type}}_data_type" name="dataTypes" value="{{data_type}}" data-parsley-group="dataTypes" {% if data_type in company.dataTypes %} checked {% end %}/><label for="{{data_type}}_data_type">{{data_type}}</label><br>
			{% end %}
			{% if list(set(company.dataTypes) - set(data_types)) %}
				<input type="checkbox" id="other_data_type" name="dataTypes" value="Other" {%if company.dataTypes[0] %}checked{%end%} data-parsley-mincheck="1" data-parsley-group='dataTypes' data-parsley-trigger="change"><label for="Other">Other</label>
				<input type="text" name="otherDataType" id="other_data_type_text_field" value="{{ list(set(company.dataTypes) - set(data_types))[0] }}" />
			{% else %}
				<input type="checkbox" id="other_data_type" name="dataTypes" value="Other" data-parsley-mincheck="1" data-parsley-group='dataTypes' data-parsley-trigger="change"><label for="Other">Other</label>
				<input type="text" name="otherDataType" id="other_data_type_text_field" />
			{% end %}
		</div>
		<input type="hidden" name="id" id="companyID" value="{{company.id}}">
	</fieldset>

	<!--*****************************************************************-DATA IMPACT-***************************************************************** !-->
	<fieldset class="m-form-half">
			<h3>What impact does open data use have on your company? (check all that apply)</h3>
			<div class="data-impacts-field">
				{% for impact in data_impacts %}
					<input type="checkbox" id="{{impact}}_data_impacts" name="dataImpacts" value="{{impact}}" data-parsley-group="dataImpacts" {% if impact in company.dataImpacts %} checked {% end %}/><label for="{{impact}}_data_impacts">{{impact}}</label><br>
				{% end%}
				{% if list(set(company.dataImpacts) - set(data_impacts)) %}
					<input type="checkbox" id="other_data_impacts" name="dataImpacts" value="Other" {%if company.dataImpacts[0] %}checked{%end%} data-parsley-mincheck="1" data-parsley-group='dataImpacts' data-parsley-trigger="change"><label for="Other">Other</label>
					<input type="text" name="otherDataImpact" id="other_data_impacts_text_field" value="{{ list(set(company.dataImpacts) - set(data_impacts))[0] }}" />
				{% else %}
					<input type="checkbox" id="other_data_impacts" name="dataImpacts" value="Other" data-parsley-mincheck="1" data-parsley-group='dataImpacts' data-parsley-trigger="change"><label for="Other">Other</label>
					<input type="text" name="otherDataImpact" id="other_data_impacts_text_field" />
				{% end %}
			</div>
		</fieldset>

	<!--*****************************************************************-ADMIN SETTINGS-***************************************************************** !-->
	<h2>Admin Settings</h2><br>
	<fieldset class="m-form">
		<fieldset class="m-form-half">
			<h3>Mark {{company.companyName}} as vetted?</h3>
				<label for="vetted"><input type="checkbox" name="vetted" id="vetted" value="vetted" {%if company.vetted %}checked{%end%}>Vetted</label>
		</fieldset>
		<fieldset class="m-form-half">
			<h3>Display {{company.companyName}} on the OD500 page?</h3>
				<label for="display"><input type="checkbox" name="display" id="display" value="display" {%if company.display %}checked{%end%}>Display</label>
		</fieldset>
		<fieldset class="m-form-half">
			<h3>Has {{company.companyName}} vetted the survey?</h3>
				<label for="vettedByCompany"><input type="checkbox" name="vettedByCompany" id="vettedByCompany" value="vettedByCompany" {%if company.vettedByCompany %}checked{%end%}>Vetted by {{company.companyName}}</label>
		</fieldset>
		<fieldset class="m-form-half">
			<h3>Has {{company.companyName}} submitted their survey?</h3>
				<label for="submittedSurvey"><input type="checkbox" name="submittedSurvey" id="submittedSurvey" value="submittedSurvey" {%if company.submittedSurvey %}checked{%end%}>Submitted Survey</label>
		</fieldset>
		<fieldset class="m-form-half">
			<h3>Prevent editing on this company (only admin can edit)?</h3>
				<label for="locked"><input type="checkbox" name="locked" id="locked" value="locked" {%if company.locked %}checked{%end%}>Lock</label>
		</fieldset>
		<fieldset class="m-form-half">
			<h3>Notes</h3>
				<textarea rows="10" cols="59" name="notes" id="notes" data-parsley-trigger="keyup" data-parsley-maxlength="3000">{%if company.notes %}{{company.notes}}{%end%}</textarea>
		</fieldset>
	</fieldset>
	<input type="hidden" class="companyID" name="companyID" id="companyID" value="{{ id }}">
	{% raw xsrf_form_html() %}
</form>
<br>

<!--*****************************************************************-AGENCY FORM-***************************************************************** !-->
<div class="m-form-box data">
	<p>Please tell us more about the open data sources your company uses.</p>
	<p>Use the search bar to find and select government agencies, subagencies, city and state governments, or government-funded research programs from the list provided.</p>
	<p>If you can't find your data provider on the list, please fill out the form <a href="/#suggest">below</a> to suggest an agency, subagency, organization, etc.</p>
	<p><strong>[Optional]:</strong> Please tell us which datasets your company uses from the agencies, city, or state governments you select, and please score each dataset on a scale of 1 to 4 (i.e. 1 = Poor; 4 = Excellent)</p>
	<p><div class="example-popup"><a>See Example.</a></div></p>
	<div class="dialog-example" style="display:none">
		<img src="{{ static_url("img/ExampleData.png") }}">
	</div>
	<div class="ui-widget">
		<label for="tags">Search: </label>
		<input id="agencyTags" placeholder="e.g. NYC, Department of Transportation, DARPA, Defense, Texas, Census..." value="" size="78">
		<input type="hidden" id="searchval" />
		<input type="button" class="l-button" id="addSearchResult" value="Add Agency/Sub-Agency">
		<input type="hidden" class="companyID" name="companyID" value="{{ company.id }}">
		<div class="errors-search">
			<span class="agency-search-error-message" style="display:inline-block;"></span>
		</div>
	</div>
	<div class="agencyList">
		<div id="accordionAgency">
			{% for agency in company.agencies %}
				<h3 class="agency" name='{{agency.name.replace(" ", "-") }}'><a href="#">{{agency.name}}</a>
					<span style="float:right; display: none;" class="toolbar ui-corner-all ui-icon ui-icon-circle-close red" subagency="" agency="{{agency.name.replace(" ","-")}}"></span>
				</h3>
				<div id="{{agency.name.replace(" ","-")}}Accordion">
					<br><h3>Agency Level Datasets</h3><br>
					<table class="datasetTable">
						<tr>
							<th class="table-header-name">Dataset Name</th>
							<th class="table-header-url">Dataset URL</th>
							<th class="table-header-rating">Rating (1-4)</th>
							<th class="table-header-buttons"></th>
						</tr>
						{% for d in agency.datasets %}{% if company == d.usedBy %}
							<tr class="dataset-row" name="{{d.datasetName}}" subagency="" agency="{{agency.name.replace(" ","-")}}">
								<td><input type="text" name="datasetName" id="datasetName" {% if (d.datasetName) %} value="{{d.datasetName}}" {% end %} ></td>
								<td><input type="text" name="datasetURL" id="datasetURL" {% if (d.datasetURL) %} value="{{d.datasetURL}}" {% end %}></td>
								<td><input type="text" name="rating" id="rating" size="3" {% if (d.rating) %} value="{{d.rating}}" {% end %}></td>
								<td><input type="button" class="l-button" id="saveDataset" value="Save"><input type="button" class="l-button" id="deleteDataset" value="Delete">
									<span class="dataset-error-message" style="display:inline-block;"></span></td>
							</tr>
						{% end %}{% end %}
						<tr class="dataset-row" subagency="" agency="{{agency.name.replace(" ","-")}}" >
							<td><input type="text" name="datasetName" id="datasetName" placeholder="Agency-Level Dataset" value=""></td>
							<td><input type="text" name="datasetURL" id="datasetURL" value=""></td>
							<td><input type="text" name="rating" id="rating" size="3" value=""></td>
							<td><input type="button" class="l-button" id="saveDataset" value="Save"><input type="button" class="l-button" id="deleteDataset" value="Delete" style="display:none">
								<span class="dataset-error-message" style="display:inline-block;"></span></td>
						</tr>
					</table>	<!---END DATASETS FROM JUST AGENCY !-->
					<!-- ROLL THROUGH SUBAGENCIES !-->
					{% if agency.subagencies %}<br><h3>Sub-Agencies</h3><br>{% end %}
					<div id="accordionSubAgency" class="{{agency.name.replace(" ", "-") }}Subagencies">
						{% for sub in agency.subagencies %}{% if company in sub.usedBy %}
							<h3 class="subagency" name="{{sub.name.replace(" ", "-") }}"><a href="#">{{sub.name}}</a>
								<span style="float:right; display: none;" class="toolbar ui-corner-all ui-icon ui-icon-circle-close red" subagency="{{sub.name.replace(" ","-")}}" agency="{{agency.name.replace(" ","-")}}"></span>
							</h3>
							<div class="{{ sub.name.replace(" ", "-") }}">
								<table class="subagencyDatasetTable">
									<tr>
										<th class="table-header-name">Dataset Name</th>
										<th class="table-header-url">Dataset URL</th>
										<th class="table-header-rating">Rating (1-4)</th>
										<th class="table-header-buttons"></th>
									</tr>
									{% for d in sub.datasets %}{%if company == d.usedBy %}
										<tr class="dataset-row" name="{{d.datasetName}}" subagency="{{ sub.name.replace(" ", "-") }}" agency="{{agency.name.replace(" ","-")}}">
											<td><input type="text" name="datasetName" id="datasetName" {% if (d.datasetName) %} value="{{d.datasetName}}" {% end %}></td>
											<td><input type="text" name="datasetURL" id="datasetURL" {% if (d.datasetURL) %} value="{{d.datasetURL}}" {% end %}></td>
											<td><input type="text" name="rating" id="rating" size="3" {% if (d.rating) %} value="{{d.rating}}" {% end %}></td>
											<td><input type="button" class="l-button" id="saveDataset" value="Save"><input type="button" class="l-button" id="deleteDataset" value="Delete">
												<span class="dataset-error-message" style="display:inline-block;"></span></td>
										</tr>
									{% end %}{% end %}
									<tr class="dataset-row" subagency="{{ sub.name.replace(" ", "-") }}" agency="{{agency.name.replace(" ","-")}}">
										<td><input type="text" name="datasetName" id="datasetName" placeholder="Subagency-Level Dataset" value=""></td>
										<td><input type="text" name="datasetURL" id="datasetURL" value=""></td>
										<td><input type="text" name="rating" id="rating" size="3" value=""></td>
										<td><input type="button" class="l-button" id="saveDataset" value="Save"><input type="button" class="l-button" id="deleteDataset" value="Delete" style="display:none">
											<span class="dataset-error-message" style="display:inline-block;"></span></td>
									</tr>
								</table>
							</div>
						{% end %}{% end %} <!-- END OF SUBAGENCIES !-->
					</div>
				</div>
			{% end %}<!-- END OF AGENCIES !-->
		</div><br>
	</div>
</div>

<!--*****************************************************************-DATA COMMENTS-***************************************************************** !-->
<form method="post" class="m-form data-comment-form" data-parsley-validate>
	<fieldset class="m-form-half right">
		<h3>Please give your comments about the usefulness of all these data sources and datasets.<br><em>[250 words or less] * </em></h3>
		<textarea rows="10" cols="59" name="dataComments" id="dataComments" 
		parsley-trigger="keyup" 
		data-parsley-maxwords="250">{%if company.dataComments %}{{ company.dataComments }}{% end %}</textarea><br>
	</fieldset>
	<!-- <input type="button" class="l-button data-submit-button" value="Save And Finish"> -->
</form>

<!--*****************************************************************-SUBMIT BUTTON-***************************************************************** !-->
<div class='submit_form'>
	<input type="submit" class="l-button" id="submit_form_admin_button" name="formSave" value="Save Company Info">
	<span class="response-message" style="display:none"></span>
</div>



<script>
$(document).ready( function () {
	//----------------------------------Admin FORM--------------------------------------
    var _xsrf = $("[name='_xsrf']").val();
    var rm = $('.response-message');
    var id = $('#companyID').val();
    $("#company_form_admin").parsley();
    $('#data_comments_form').parsley();
    $('.submit_form').on('click', '#submit_form_admin_button', function() {
        if ($("#company_form_admin").parsley().validate() && $('.data-comment-form').parsley().validate()) {
            data = $('#company_form_admin').serializeArray();
            data[data.length] = { name: "dataComments", value: $('#dataComments').val() };
            $.ajax({
		        type: 'POST',
		        url: '/admin-edit/' + id,
		        data: data,
		        error: function(error) {
		            console.debug(JSON.stringify(error));
		            rm.text("Oops... Something went wrong.").show().delay(5000).fadeOut();
		          	$("#submit_form_admin_button").prop("disabled", false); 
		        },
		        beforeSend: function(xhr, settings) {
		          $("#submit_form_admin_button").prop("disabled", true); 
		          rm.text("Saving...").show().delay(5000).fadeOut();
		        },
		        success: function(success) {
		          $("#submit_form_admin_button").prop("disabled", false); 
		          rm.text("Saved!").show().delay(5000).fadeOut();
		          console.log("regular saved!");
		          document.location.href = '/admin/companies/';
		        }
		      });
        } else {
        	rm.text("You need to fix some errors.");
        	rm.show().delay(5000).fadeOut();
        }
        event.preventDefault();
    });
});

</script>








{% end %}