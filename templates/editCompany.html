{% extends "main.html" %}
{% autoescape None %}

{% block body %}
<h2>{{ page_heading }}</h2>

<form method="post" id="submitCompany" class="m-form companyForm">
	<fieldset class="m-form-half">
		<h3>Personal Information</h3>
		<div class="m-form-line"><label for="">First Name: *</label><input type="text" name="firstName" id="firstName" parsley-required="true" {% if (company.contact) %} value="{{ company.contact.firstName }}" {% end %}></div>
		<div class="m-form-line"><label for="">Last Name: *</label><input type="text" name="lastName" id="lastName" parsley-required="true" {% if (company.contact) %} value="{{ company.contact.lastName }}" {% end %}></div>
		<div class="m-form-line"><label for="">Title:</label><input type="text" name="title" id="title" {% if (company.contact) %} value="{{ company.contact.title }}" {% end %}></div>
		<div class="m-form-line"><label for="">Email: *</label><input type="text" name="email" id="email" parsley-trigger="change" parsley-type="email" parsley-required="true" {% if (company.contact) %} value="{{ company.contact.email }}" {% end %}></div>
		<div class="m-form-line"><label for="">Phone:</label><input type="text" name="phone" id="phone" parsley-trigger="change" parsley-type="phone" {% if (company.contact) %} value="{{ company.contact.phone }}" {% end %}></div>
		<div class="m-form-box contacted-box"><label for="contacted"><input type="checkbox" name="contacted" id="contacted" value="contacted" {% if (company.contact) %}{% if company.contact.contacted %} checked {% end %}{% end %}>Please check here if you would be willing to be contacted for further information about your company.</label></div>
	</fieldset>
	<fieldset class="m-form-half right">
		<h3>Company Information</h3>	
		<div class="m-form-line"><label for="companyName">Name of your company: *</label><input type="text" name="companyName" id="companyName" parsley-required="true" value="{{ company.companyName }}" ></div>
		<div class="m-form-line"><label for="url">Company URL: *</label><input type='text' name="url" id='url' parsley-trigger="change" parsley-type="url" parsley-required="true" value="{{ company.url }}"></div>
		<div class="m-form-line"><label for="city">In which city is this company located?</label><input type="text" name="city" id="city" {% if company.city %} value="{{ company.city }}" {% end %}></div>
		<div class="m-form-line">
			<label for="state">State:</label>
			<select name='state' id="state" >
				{% for i in range(0, 53) %}
					<option name="state" value="{{stateListAbbrev[i]}}" {%try%}{%if company.state.replace(' ','') == stateListAbbrev[i] %} selected="selected" {%end%}{%except%}{%end%}>{{ stateList[i] }}</option>
				{%end%}
			</select>
		</div>
		<div class="m-form-line"><label for="zipCode">Zip Code:</label><input type="text" name="zipCode" id="zipCode" parsley-trigger="change" parsley-regexp="(^\d{5}$)|(^\d{5}-\d{4}$)" {% if company.zipCode %} value="{{ company.zipCode }}" {% end %}></div>
		<div class="m-form-line"><label for="ceoFirstName">First Name of CEO:</label><input type="text" name="ceoFirstName" id="ceoFirstName" value="{{ company.ceo.firstName}}"></div>
		<div class="m-form-line"><label for="ceoLastName">Last Name of CEO:</label><input type="text" name="ceoLastName" id="ceoLastName" value="{{ company.ceo.lastName }}"></div>
		<div class="m-form-line"><label for="ceoEmail">CEO Email:</label><input type="text" name="ceoEmail" id="ceoEmail" data-trigger="change" data-type="email" value="{{ company.ceo.email }}"></div>
		<div class="m-form-box">Type of Company: *<br>
		{% for type in companyType %}
			<label for=""><input type="radio" name="companyType" data-trigger="change" data-group="companyType" data-mincheck="1" value="{{ type }}" {% if company.companyType == type %} checked {% end %}>{{ type }}</label>
		{% end %}
		{%if company.companyType not in companyType %}
			<label for=""><input type="radio" name="companyType" data-trigger="change" data-group="companyType" data-mincheck="1" value="other" checked>Other
			<input type="text" name="otherCompanyType" id="otherCompanyType" data-trigger="change" data-group="companyType" data-mincheck="1" value ="{{ company.companyType }}"></label>
		{% else %}
			<label for=""><input type="radio" name="companyType" data-trigger="change" data-group="companyType" data-mincheck="1" value="other">Other
			<input type="text" name="otherCompanyType" id="otherCompanyType" data-trigger="change" data-group="companyType" data-mincheck="1"></label>
		{% end %}
		</div>
		<div class="m-form-line"><label for="">Founding Year:</label><input type="text" name="yearFounded" id="yearFounded" parsley-type="number" parsley-trigger="change" parsley-range="[1000, 2014]" {% if company.yearFounded %} value="{{ company.yearFounded }}" {%end%}></div>
		<div class="m-form-line"><label for="">Number of FTE's:</label><input type="text" name="fte" id="fte" parsley-trigger="change" parsley-type="number" {% if company.fte %} value="{{ company.fte }}" {%end%}></div>
	</fieldset>

	<fieldset class="m-form-half">
		<h3>Which best describes the function of your company? *</h3>
		{% for function in companyFunction %}
			<label for=""><input type="radio" name="companyFunction" data-trigger="change" data-group="companyFunction" data-mincheck="1" value="{{ function }}" {% if company.companyFunction == function %} checked {% end %}>{{ function }}</label><br>
		{% end %}
		{%if company.companyFunction not in companyFunction %}
			<label for=""><input type="radio" name="companyFunction" parsley-required="true" value="other" checked>Other</label><br>
			<label for=""><input type="text" name="otherCompanyFunction" id="otherCompanyFunction" data-trigger="change" data-group="companyFunction" data-mincheck="1" value="{{ company.companyFunction }}"></label><br>
		{% else %}
			<label for=""><input type="radio" name="companyFunction" parsley-required="true" value="other">Other</label>
			<label for=""><input type="text" name="otherCompanyFunction" id="otherCompanyFunction" data-trigger="change" data-group="companyFunction" data-mincheck="1"></label>
		{% end %}
	</fieldset>
	
	<fieldset class="m-form-half right">
		<h3>Which of the following are critical sources of data for your company? By “critical,” we mean that your company would have to shut down a line of business, shut down completely, or replace the data in some way if the data were no longer available.<br><em>(check all that apply)</em> *</h3>
		{% for dataType in criticalDataTypes %}
			<label for=""><input type="checkbox" name="criticalDataTypes" data-trigger="change" data-group="criticalDataTypes" data-mincheck="1" value="{{ dataType }}" {% if dataType in company.criticalDataTypes %} checked {% end %}>{{ dataType }}</label><br>
		{% end %}
		{% if list(set(company.criticalDataTypes) - set(criticalDataTypes)) %}
			<label for=""><input type="checkbox" name="criticalDataTypes" parsley-required="true" value="Other" checked>Other</label>
			<label for=""><input type="text" name="otherCriticalDataTypes" id="otherCriticalDataTypes" data-trigger="change" data-group="criticalDataTypes" data-mincheck="1" value="{{ list(set(company.criticalDataTypes) - set(criticalDataTypes))[0] }}"></label><br>
		{% else %}
			<label for=""><input type="checkbox" name="criticalDataTypes" parsley-required="true" value="Other">Other</label>
			<label for=""><input type="text" name="otherCriticalDataTypes" id="otherCriticalDataTypes" data-trigger="change" data-group="criticalDataTypes" data-mincheck="1"></label>
		{% end %}
	</fieldset>
	<fieldset class="m-form-half">
		<h3>Which of the following are significant sources of revenue for your company? <br><em>(check all that apply)</em> *</h3>
		{% for source in revenueSource %}
			<label for=""><input type="checkbox" name="revenueSource" data-trigger="change" data-group="revenueSource" data-mincheck="1" value="{{ source }}" {% if source in company.revenueSource %} checked {% end %}>{{ source }}<br>
		{% end %}
		{% if list(set(company.revenueSource) - set(revenueSource)) %}
			<label for=""><input type="checkbox" name="revenueSource" parsley-required="true" value="Other" checked>Other
			<input type="text" name="otherRevenueSource" id="otherRevenueSource" data-trigger="change" data-group="revenueSource" data-mincheck="1" value="{{ list(set(company.revenueSource) - set(revenueSource))[0] }}"></label>
		{% else %}
			<label for=""><input type="checkbox" name="revenueSource" parsley-required="true" value="Other">Other
			<input type="text" name="otherRevenueSource" id="otherRevenueSource" data-trigger="change" data-group="revenueSource" data-mincheck="1"></label>
		{% end %}
	</fieldset>
	<fieldset class="m-form-half right">
		<h3>What category best describes your company? *</h3>
		{% for category in categories %}
			<label for=""><input type="radio" name="category" value="{{ category }}" {% if category == company.companyCategory %} checked {% end %}>{{ category }}<br>
		{% end %}
		{% if company.companyCategory not in categories %}
			<label for=""><input type="radio" name="category" class="otherCategory" parsley-required="true" value="Other" checked>Other
			<input type="text" name="otherCategory" id="otherCategory" class="otherCategory" {% if company.companyCategory %}value="{{ company.companyCategory }}"{%end%}></label>
		{% else %}
			<label for=""><input type="radio" name="category" class="otherCategory" parsley-required="true" value="Other">Other
			<input type="text" name="otherCategory" id="otherCategory" class="otherCategory"></label>
		{% end %}
	</fieldset>
	<fieldset class="m-form-half">
		<h3>Please give us a short public statement describing your company’s mission and work. You can take this material from your website or other publications if you choose to. <br><em>[200 words or less]</em> *</h3>
		<textarea rows="10" cols="59" name="descriptionLong" id="descriptionLong" parsley-trigger="keyup" parsley-maxwords="200" parsley-required="true">{{ company.descriptionLong }}</textarea><br>
		<h3>As a summary, please provide a one sentence description of your company. <br><em>[25 words or less]</em> *</h3>
		<textarea rows="10" cols="59" name="descriptionShort" id="descriptionShort" parsley-trigger="keyup" parsley-maxwords="25" parsley-required="true">{{ company.descriptionShort }}</textarea><br>
		<h3>Besides revenue generation, how do you measure the impact your company has for society and the public good? <br><em>[50 words or less]</em></h3>
		<textarea rows="10" cols="59" name="socialImpact" id="socialImpact" parsley-trigger="keyup" parsley-maxwords="50">{{ company.socialImpact }}</textarea><br>
	</fieldset>
	<fieldset class="m-form-half right">
		<h3>Please include any financial or operational information that will help us understand your company. We are interested in specific information like past and projected annual revenues, total outside investment dollars to date, and significant investors or partners. <br><em>[100 words or less]</em></h3>
		<textarea rows="10" cols="59" name="financialInfo" id="financialInfo" parsley-trigger="keyup" parsley-maxwords="100">{{ company.financialInfo }}</textarea><br>
		<h3>What datasets (if any) are not currently available that would be useful for your company to have as government open data? <br><em>[50 words or less]</em></h3>
		<textarea rows="10" cols="59" name="datasetWishList" id="datasetWishList" parsley-trigger="keyup" parsley-maxwords="50">{%if company.contact %}{{ company.contact.datasetWishList }}{%end%}</textarea>
		<h3>What other companies, either in your sector or other sectors, would you recommend we contact regarding their use of government open data? <br><em>[50 words or less]</em></h3>
		<textarea rows="10" cols="59" name="companyRec" id="companyRec" parsley-trigger="keyup" parsley-maxwords="50">{%if company.contact %}{{ company.contact.companyRec}}{%end%}</textarea>
		<h3>What conferences or events do you think would be helpful to us in surveying the field of open data companies? <br><em>[50 words or less]</em></h3>
		<textarea rows="10" cols="59" name="conferenceRec" id="conferenceRec" parsley-trigger="keyup" parsley-maxwords="50">{%if company.contact %}{{ company.contact.conferenceRec }}{%end%}</textarea>
	</fieldset>
</form>
	<!--------------------------------------------DATASETS--------------------------------------!-->
<form method="post" class="m-form dataForm">
	<div class="m-form-box">
		<h3>Datasets</h3>
		<div class="dataList">
			{% if company.datasets %}
				<ul>
				{% for dataset in company.datasets %}
					<li>
						<p>{{dataset.datasetName}} <input type="button" name="editData" datasetName="{{dataset.datasetName}}" class="m-button" id="editData" value="Edit"><span class="savedMessage" style="display:none">Saved!</span></p>
						<div datasetName="{{dataset.datasetName}}" datasetURL="{{dataset.datasetURL}}" agency="{{dataset.agency}}" dataType="{%for t in dataset.dataType %}{{ t }},{%end%}" {%try%}{%if dataset.ratings %} rating="{{dataset.ratings[0].rating}}" {%if dataset.ratings[0].reason %} reason="{{dataset.ratings[0].reason}}"{%end%}{%end%}{%except%}{%end%} datasetid="{{dataset.id}}"></div>
					</li>
				{% end %}
				</ul>
			{% else %}
				<div class="noDatasets"><p>No Datasets</p></div>
			{% end %}
			<br>
		</div>
		<div class="m-form-box" id="dataForm" style="display:none">
			<div class="m-form-half left">
				<div class="dataFormTitle"></div>
				<div class="m-form-line"><label for="datasetName">Name of Dataset: * </label><input type="text" name="datasetName" parsley-trigger="change" parsley-required="true"></div>
				<div class="m-form-line"><label for="datasetURL">URL of Dataset: * </label><input type="text" name="datasetURL" parsley-required="true" parsley-trigger="change" parsley-type="url"></div>
				<div class="m-form-line"><label for="agency">Agency or Source: * </label><input type="text" name="agency" parsley-required="true" parsley-trigger="change"></div>
				<h3>Type of Dataset: *</h3>
				<label for=""><input type="checkbox" name="dataType" value="Federal Open Data">Federal Open Data</label><br>
				<label for=""><input type="checkbox" name="dataType" value="State Open Data">State Open Data</label><br>
				<label for=""><input type="checkbox" name="dataType" value="City/Local Open Data">City/Local Open Data</label><br>
				<label for=""><input type="checkbox" name="dataType" parsley-required="true" value="Other">Other <label for=""><input type="text" name="otherDataType"></label></label>
				<h3>On a scale of 1 to 4, how would you rate the usefulness of this dataset? (1- poor, 4- excellent) Your answer can reflect your experience with data quality, format of the data, or other factors.</h3>
				<input type="text" name="rating" parsley-trigger="change" parsley-range="[0, 4]">
				<h3>Why did you give it this rating? [50 words or less]</h3>
				<textarea rows="6" cols="70" name="reason" parsley-trigger="keyup" parsley-maxwords="50"></textarea><br>
				<input type="hidden" id="companyID" name="companyID" value="{{ id }}">
				<input type="hidden" id="datasetID" name="datasetID" value="">
				{% raw xsrf_form_html() %}
				<input type="button" name="addData" class="m-button" id="addNew" value="Add" style="display:none">
				<input type="button" name="saveData" class="m-button" id="saveData" value="Save" style="display:none">
				<input type="button" name="cancel" class="m-button" id="cancel" value="Cancel">
				<span class="errorMessage" style="display:none">Oops, something went wrong</span>
				<span class="savingMessage" style="display:none">Saving...</span>
			</div>
		</div>
		<input type="button" class='m-button' id="addDataset" name="dataAdd" value="Add Dataset">
		</fieldset>
		<!--------------------------------------------END DATASETS--------------------------------------!-->
	</div>
	<h3>Are you ready to submit this information? Using this same link you will be able to come back and edit this information until we review it in the next couple of days. Once we review it and approve the changes, you will have to contact us to make any changes.</h3>
	<div class="m-form-footer">	
		{% raw xsrf_form_html() %}
		<input type="hidden" class="id" name="id" value="{{ id }}">
		<input class="m-button" id="submit" name="companyEdit" value="Submit Form">
	</div>
</form>


<script type="text/javascript">
$(document).ready(function() { 
	$('#addDataset').on( 'click', function( event ) {
		$('#dataForm').show();
		$('.dataFormTitle').html('<h3>New Dataset</h3>');
		$('#saveData').hide();
		$('#addNew').show();
		$('#addDataset').hide();
	});
	$('#editData').on( 'click', function( event ) {
		$('#editData').hide();
		$('.dataFormTitle').html('<h3>Editing Dataset</h3>');
		$('#dataForm').show();
		$('#addNew').hide();
		$('#saveData').show();
		$('#addDataset').hide();
		//fill out fields
		var datasetName = $(this).attr('datasetname');
		var datasetURL = $("div[datasetname='"+datasetName+"']").attr('dataseturl');
		var agency = $("div[datasetname='"+datasetName+"']").attr('agency');
		var dataType = $("div[datasetname='"+datasetName+"']").attr('datatype').split(",");
		dataType.pop();
		var rating = $("div[datasetname='"+datasetName+"']").attr('rating');
		var reason = $("div[datasetname='"+datasetName+"']").attr('reason');
		var datasetID = $("div[datasetname='"+datasetName+"']").attr('datasetid');
		$("input[name='datasetName']").val(datasetName);
		$("input[name='datasetURL']").val(datasetURL);
		$("input[name='agency']").val(agency);
		for (var i = 0; i < dataType.length; i++) {
			$("input:checkbox[value='" + dataType[i] + "']").attr("checked", true);
		}
		$("input[name='rating']").val(rating);
		$("textarea[name='reason']").val(reason);
		$("input[name='datasetID']").val(datasetID);
	});
	$('#cancel').on( 'click', function( event ) {
		$('#dataForm').hide();
		$('#saveData').hide();
		$('#addNew').hide();
		$('#addDataset').show();
		$('#editData').show();
	});
	$('#addNew').on( 'click', function( event ) {
		if ( $('.dataForm').parsley('validate') ) {
            console.log("form is valid");       
        } else {
        	console.log("not valid");
        }
    });
    $('#saveData').on( 'click', function( event ) {
    	event.preventDefault();
		if ( $('.dataForm').parsley('validate') ) {
			$('.savingMessage').show();
			var id = $('.id').val();
			$.ajax({
				type: 'POST',
				url: '/editData/' + $('#datasetID').val(),
            	data: $('.dataForm').serializeArray(),
				error: function(error) {
					console.debug(JSON.stringify(error));
					$('.savingMessage').hide();
					$('.errorMessage').fadeIn(); },
				beforeSend: function(xhr, settings) {
					$(event.target).attr('disabled', 'disabled'); },
				success: function() {
					$(event.target).removeAttr('disabled');
					$('.savingMessage').hide();
					$('.errorMessage').hide();
					$('#editData').show();
					$('.savedMessage').show().delay(5000).fadeOut();
					$('.dataForm')[0].reset();
					$('#datasetID').val('');
					$('#dataForm').hide();
					$('#saveData').hide();
				}
			});
        } else {
        	console.log("not valid");
        }
    });
    //submit data on click and check if valid 
    // $('.dataForm').submit(function(e) { 
    // 	e.preventDefault();
    // 	if ( $('dataForm').parsley('validate') ) {
    //         console.log("form is valid");       
    //     } else {
    //     	console.log("not valid");
    //     }
    // });
}); 
</script>

{% end %}