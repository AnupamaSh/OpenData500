{% extends "main.html" %}
{% autoescape None %}

{% block body %}

<section>
	<h1 class="m-page-title">{{ page_heading }}</h1>
	<p class="intro">Explore our preliminary working list of companies that we believe meet our criteria for the Open Data 500. We have invited all listed companies to fill out our survey. Information is shown as companies have provided it to us.</p>
	<p class="warning"><strong>How to use this page:</strong> Click on a square to expand it and read the brief company description. Click on a company's name to view more information and for a space to comment.</p>
	<p class="warning"><strong>Please Note:</strong> We expect to that this list may change as we learn more about how each company operates – that’s part of our open process. Many of these companies have not yet responded to our survey, so information about them may change as we receive more input from them and from others.</p>
</section>

<div class="m-candidates">
    
    <div class="m-filter-menu">
        <h3>Filter by Category</h3>
        <div id="filters" class="m-candidates-buttons button-group" data-toggle="buttons-checkbox">
            <button data-filter="*">Show All</button>
            {% for category in categories %}
                <button data-filter=".{{category.strip().replace(" ", "-").replace("/","").replace("&", "")}}">{{category}}</button>
            {%end%}
        </div>
    </div>

    <div id="chart"></div>
    <div class="legend" id="legend">
    	<span>Filter by:  </span>
    	<span class="color survey" data-filter=".survey-company">Submitted Survey</span>
    	<span class="color candidate" data-filter=":not(.survey-company)">No Survey Submitted</span>
    	<span class="color all" data-filter="*">Show all</span>
    </div>
	<div class="m-candidates isotopes-container" data-isotope-options='{ "layoutMode": "fitColumns" }'>
		{% for company in companies %}
            <div class="m-candidates-item {%try%} {{company.companyCategory.strip().replace(" ", "-").replace("/","").replace("&", "")}} {%except%}None{%end%} {{ company.state }} {% if company.submittedSurvey %} survey-company{%end%}">
                <a href="/{{company.prettyName}}"><h3><strong>{{ company.companyName }}</strong></h3></a>
                <p class="m-homepage-list-location"> {%try%}{{ states[company.state] }}{%except%}{%end%}</p>
                <em> {{ company.companyCategory }}</em>
                <p class="m-homepage-list-desc">{{ company.descriptionShort }}</p>
			</div>
		{%end%}
	</div>
</div>

<div id="hidden" style="display:none;"><[{% for s in stats.states %}{% if s.abbrev == "PR" %}{"abbrev": "{{s.abbrev}}","STATE":"{{s.name}}","VALUE":"{{s.count}}"}{%else%}{"abbrev": "{{s.abbrev}}","STATE":"{{s.name}}","VALUE":"{{s.count}}"},{%end%}{%end%}]></[{%for s in stats.states %}{% if s.abbrev == "PR" %}{"abbrev": "{{s.abbrev}}","STATE":"{{s.name}}","VALUE":"{{s.count}}"}{%else%}{"abbrev": "{{s.abbrev}}","STATE":"{{s.name}}","VALUE":"{{s.count}}"},{%end%}{%end%}]></div>


<script src="{{ static_url("js/d3.v3.min.js") }}"></script>
<script src="{{ static_url("js/queue.v1.min.js") }}"></script>
<script src="{{ static_url("js/isotope.pkgd.min.js") }}"></script>
<script>
(function(){
	var $container = $('.isotopes-container').isotope({
		layoutMode: 'fitRows',
		resizesContainer : false,
	});
	// filter items on button click
	$('#filters').on( 'click', 'button', function( event ) {
	  var filtr = $(this).attr('data-filter');
      $("#filters button").removeClass('s-active');
      $(this).addClass('s-active');
	  $container.isotope({ filter: filtr });
	});

	// filter items by survey type
	$('#legend').on( 'click', 'span', function( event ) {
	  var filtr = $(this).attr('data-filter');
	  $container.isotope({ filter: filtr });
	});

	// $('.states').on('click', 'path', function(event) {
	// 	var filtr = $(this).attr('class').split(' ')[1];
	// 	//$container.isotope({ filter: filtr });
	// 	console.log(filtr);
	// });

	$container.delegate( '.m-candidates-item', 'click', function(){
			//$('.m-candidates-item.large').removeClass('large');
	        $(this).toggleClass('s-active');
	        $container.isotope();
	});
            
    var userData = document.getElementById('hidden').textContent.replace('<','').replace('>','');
    console.log(userData);
    userData = JSON.parse(userData)
    data = userData
    
    createChart = function(){
        var hoverDisplay = "State &amp; Value".replace('&amp;', '&')
        
        //General chart
        this.Title = '500 Companies';
        this.Size = 600;
        this.MarginTop = 60;
        this.MarginRight = 40;
        this.MarginBottom = 40;
        this.MarginLeft = 40;
        this.Guide = false;
        this.DataType = 'Number';
        this.BackgroundColor = 'transparent';
        //States
        this.StateBaseColor = '#eeeeee';
        this.StateMaxColor = '#4a2f76';
        this.Range = 40;
        this.LineThickness = .6;
        this.LineColor = '#888';
        //Labels
        this.ChartTitle = true;
        this.ChartTitleText = 'Filter By State';
        this.ChartTitleXLocation = 'Center';
        this.ChartTitleYLocation = 0;
        this.ChartTitleFont = 'Arial';
        this.ChartTitleSize = 24;
        this.ChartTitleColor = '#472b74';
        this.PointLabel = true;
        this.PointLabelLocation = -10;
        this.PointLabelFont = 'Arial';
        this.PointLabelSize = 14;
        this.PointLabelColor = '#000000';
        //Hover State
        this.HoverStates = true;
        this.HoverDisplay = hoverDisplay;
        this.HoverLabelFont = 'Arial';
        this.HoverLabelSize = 10;
        this.HoverLabelColor = '#000000';
        this.HoverValueFont = 'Arial';
        this.HoverValueSize = 16;
        this.HoverValueColor = '#000000';
        
        this.mainChart = function() {
        
            var height = 550;
            var width = 950;
            
            var size = this.Size/width,
                marginTop = this.MarginTop,
                marginRight = this.MarginRight,
                marginBottom = this.MarginBottom,
                marginLeft = this.MarginLeft,
                guideOn = this.Guide,
                dataType = this.DataType,
                backgroundColor = this.BackgroundColor,
                stateBaseColor = this.StateBaseColor,
                stateMaxColor = this.StateMaxColor,
                range = this.Range,
                lineThickness = this.LineThickness,
                lineColor = this.LineColor,
                chartTitle = this.ChartTitle,
                chartTitleText = this.ChartTitleText,
                chartTitleXLoc = this.ChartTitleXLocation,
                chartTitleYLoc = this.ChartTitleYLocation,
                chartTitleFont = this.ChartTitleFont,
                chartTitleSize = this.ChartTitleSize,
                chartTitleColor = this.ChartTitleColor,
                pointLabelLoc = this.PointLabelLocation,
                pointLabelFont = this.PointLabelFont,
                pointLabelSize = this.PointLabelSize,
                pointLabelColor = this.PointLabelColor,
                hoverStates = this.HoverStates,
                hoverDisplay = this.HoverDisplay,
                hoverLabelFont = this.HoverLabelFont,
                hoverLabelSize = this.HoverLabelSize,
                hoverLabelColor = this.HoverLabelColor,
                hoverValueFont = this.HoverValueFont,
                hoverValueSize = this.HoverValueSize,
                hoverValueColor = this.HoverValueColor;
                
            var margin = {top: marginTop, right: marginRight, bottom: marginBottom, left: marginLeft},
                w = (width*size) + margin.left + margin.right,
                h = (height*size) + margin.top + margin.bottom;
                
            var bkgdColor = document.getElementsByTagName("body")[0];
            bkgdColor.setAttribute("style","background-color:" + backgroundColor + ";margin:0px;");

            var elem = document.getElementById("chart");
            elem.setAttribute("style","width:" + w + "; height:" + h + "; ");
            
            var graph = d3.select('#chart').append('svg')
                .attr('width', w)
                .attr('height', h);
                
            //Background Color
            graph.append("svg:rect")
                .attr("class", "bkgd")
                .attr("width", w)
                .attr("height", h)
                .style("fill", "none");
                
            var group = graph.append('g');
            
            var hover = d3.select("#chart")
                .append("div")
                .attr("class", "tooltip")
                .style("position", "absolute")
                .style("z-index", "1000")
                .style("padding", "5px")
                .style("font-family", hoverLabelFont)
                .style("font-size", hoverLabelSize)
                .style("color", hoverLabelColor);
                
            queue()
                .defer(d3.json, "{{ static_url("us_states.json") }}")
                .await(ready);
                
            var numberFormat = d3.format("0,000");
            var percentFormat = function(d) { return numberFormat(d) + "%"; };
            var dollarFormat = function(d) { return "$" + numberFormat(d); };
            
            var projection = d3.geo.albersUsa();
            var path = d3.geo.path()
                .projection(projection);
                
            group.attr('transform', 'translate(' + margin.left + ', ' + margin.top + '),scale(' + size + ', ' + size + ')');
            
            var color = d3.scale.linear().domain([0,range]).range([stateMaxColor, stateBaseColor]);
            
            var maxVal = d3.max(data, function(d) { return d.VALUE; });
            var minVal = d3.min(data, function(d) { return d.VALUE; });
            var total = maxVal - minVal;
            
            var number = d3.format("0,000");
            
            function ready(error, us, _data) {
            
                group.selectAll('path')
                    .data(us.features)
                    .enter().append('path')
                    .attr('class', 'states')
                    .attr('d', d3.geo.path().projection(projection))
                    //.attr('id', function(d){return d.properties.name.replace(/\s+/g, '')})
                    .style('stroke', lineColor)
                    .style('stroke-width', lineThickness/size);
                    
                group.selectAll('.states')
                    .data(data)
                    .style('fill', function(d){return color( total/d.VALUE )})
                    .on("mouseover", function(d, i) {   
                        if (hoverStates == true) {
                                hover.transition().duration(100).style("opacity", 1)
                                    .style("background-color", color(total/d.VALUE))
                                    .style("left", (d3.event.pageX) + 20 + "px")
                                    .style("top", (d3.event.pageY) + "px");
                        if (hoverDisplay == "State & Value") {
                                if (dataType == "Number") hover.html(d.STATE + "<br><span style='font-size:" + hoverValueSize + ";font-family:" + hoverValueFont + ";color:" + hoverValueColor + ";'>" + numberFormat(d.VALUE) + "</span>");
                                if (dataType == "Percent") hover.html(d.STATE + "<br><span style='font-size:" + hoverValueSize + ";font-family:" + hoverValueFont + ";color:" + hoverValueColor + ";'>" + percentFormat(d.VALUE) + "</span>");
                                if (dataType == "Dollar") hover.html(d.STATE + "<br><span style='font-size:" + hoverValueSize + ";font-family:" + hoverValueFont + ";color:" + hoverValueColor + ";'>" + dollarFormat(d.VALUE) + "</span>");
                        }
                            if (hoverDisplay == "Value") {
                                if (dataType == "Number") hover.html("<span style='font-size:" + hoverValueSize + ";font-family:" + hoverValueFont + ";color:" + hoverValueColor + ";'>" + numberFormat(d.VALUE) + "</span>");
                                if (dataType == "Percent") hover.html("<span style='font-size:" + hoverValueSize + ";font-family:" + hoverValueFont + ";color:" + hoverValueColor + ";'>" + percentFormat(d.VALUE) + "</span>");
                                if (dataType == "Dollar") hover.html("<span style='font-size:" + hoverValueSize + ";font-family:" + hoverValueFont + ";color:" + hoverValueColor + ";'>" + dollarFormat(d.VALUE) + "</span>");
                            }
                        }
                    })
                    .on("mouseout", function(d) { if (hoverStates == true) hover.style("left", -100).style("top", -100).transition().duration(100).style("opacity", 0); })
                    .on("mousemove", function(d, i) { if (hoverStates == true)hover.style("left", (d3.event.pageX) + 20 + "px").style("top", (d3.event.pageY) + "px"); })
                    .on('click', function(d) { 
                        var filtr = "." + d.abbrev; 
                        $container.isotope({ filter: filtr }); 
                        console.log(filtr); 
                        $("#filters button").removeClass('s-active');
                    });
                    
                if (chartTitleXLoc == "Left") { var cxpos = margin.left; var ctextanchor = "start"; };
                if (chartTitleXLoc == "Center") { var cxpos = (w - margin.right - margin.left)/2 + margin.left; var ctextanchor = "middle"; };
                if (chartTitleXLoc == "Right") { var cxpos = (w - margin.right - margin.left) + margin.left; var ctextanchor = "end"; };
                
                if (chartTitle == true) {
                graph.append("text")
                    .attr("transform", "translate(" + cxpos + "," + (margin.top + chartTitleYLoc) + ")")
                    .style({ 'text-anchor': ctextanchor, 'font-family': chartTitleFont, 'font-size': chartTitleSize, 'fill': chartTitleColor})
                    .text(chartTitleText);
                }
                
            }
            
        };
        
            this.updateChart = function(){
                d3.select("svg").remove()
                this.mainChart()
            };  
        };
        
    var chart = new createChart()         
    chart.mainChart()
})()</script>





{% end %}